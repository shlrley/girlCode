from main import app
from main import request
from main import json
from model import Product
import sqlite3
import pandas as pd

@app.route('/product',methods=['POST'])
def index():
    try:
        data = json.loads(request.data)
        p = Product(data)
        product = json.loads(p.get())

        con = sqlite3.connect("../user_products.db")
        sql_query = pd.read_sql_query("select * from user_products")
        df = pd.DataFrame(sql_query, columns = ['customer', 'product'])

        if p.user in df['customer']:
            if p.item in df['product']:
                print('User and product already in database.')
                return json.dumps(data)
            else:
                cur = con.cursor()
                cur.execute("INSERT INTO user_products (customer, product) VALUES (?, ?);", (self.user, self.item))
                return json.dumps(data)
        else:
            cur = con.cursor()
            cur.execute("INSERT INTO user_products (customer, product) VALUES (?, ?);", (self.user, self.item))
            return json.dumps(data)

        response = app.response_class(
            response= json.dumps(data_to_send),
            status=200,
            mimetype='application/json'
        )
        return response
    except:
        response = app.response_class(
            response=json.dumps({"message":"The server encountered an error with your request"}),
            status=403,
            mimetype='application/json'
        )
        return response